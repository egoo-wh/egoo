#!/usr/bin/env node
import e from"path";import t from"yargs";import s from"ansi-colors";import{EventEmitter as r}from"events";import n from"fancy-log";import i from"node-fetch";import o from"lodash";import"prompt";import a,{promises as c}from"fs";import"stream";import l from"iconv-lite";import{Transform as h}from"readable-stream";import u from"pump";import p from"pumpify";import d from"jschardet";import{Client as f}from"ssh2";import{createRequire as m}from"module";import w from"os";import g from"crypto";import{AsyncSeriesHook as y,AsyncSeriesBailHook as P}from"tapable";class v extends r{constructor(){super(),this.on("shutdown",this.shutdownHandler)}}function S(e,t=""){let r;switch(t){case"PATH":r=s.cyan;break;case"ERROR":r=s.red;break;case"STEP":r=s.yellow;break;case"TIP":r=s.magenta;break;case"SUCCESS":r=s.green;break;case"UNDERLINE":r=s.underline;break;default:r=s.white}return r(e)}function b(e){return(...t)=>{n.info(`${e}: `,...t)}}let E;function T(...t){if(!E)throw new Error("use setAppRoot before");return e.join(E,...t)}function I(...e){return e.reduce(((e,t)=>{let s="";return s="string"==typeof t?t:Array.isArray(t)?t.join("/"):t.toString(),e?e+"/"+s:s}),"")}function x(e){return"http://cli.egooidea.com/"+e}function k(e){return T("data",e)}async function R(t,s){if(!s)throw new Error("no handler function");let r;try{r=await c.lstat(t)}catch(e){throw new Error("src is invalid")}if(r){if(r.isDirectory()){s&&s.call(null,{filePath:t,type:"dir"});let r=(await c.readdir(t)).map((r=>{if(!/(^|\/)\.[^\/\.]/g.test(r))return R(e.join(t,r),s)}));return Promise.all(r)}{let e=s&&s.call(null,{filePath:t,type:"file"});return!(n=e)||"object"!=typeof n&&"function"!=typeof n||"function"!=typeof n.then?Promise.resolve(e):e}var n}}function H(e,t,s,...r){if(!e)throw new Error("can't find function for sfcall.");return new Promise(((n,i)=>{try{e.apply(t,r.concat((function(e){s?n(!e):e?i(e):n()})))}catch(e){i(e)}}))}async function C(e,t){if(!t)throw new Error("cp dest is empty");let s;try{s=await c.lstat(e)}catch(e){throw new Error("cp src is not exist")}if(s.isDirectory()){let e;try{e=await c.lstat(t)}catch(e){return c.mkdir(t,511)}return e.isDirectory()?Promise.resolve():c.mkdir(t,511)}return c.copyFile(e,t)}let F={};function j(e){return new Promise((function(t,s){let r;if(F&&e&&F[e])r=F[e],t(r);else{let r,n=a.createReadStream(e,{emitClose:!0});n.on("error",(e=>{s(e)})),n.on("data",(function(t){let s=d.detect(t);r=s.encoding,F[e]=r,n.close()})),n.on("close",(function(e){r=r||"utf8",t(r)}))}}))}var _={detectFileEncode:j,isFileEncodeEqual:function(e,t){let s=e.toUpperCase(),r=t.toUpperCase();if(s==r)return!0;let n=[["UTF8","UTF-8"],["GBK","GB2312"]];for(let e=0;e<n.length;e++){let t=n[e].indexOf(s);if(t>=0)return n[e][(t+1)%2]==r}return!0},modify:async function(e,t,s){s=s||[];const r=await j(e);if(!l.encodingExists(r))throw new Error("unsupport encoding "+r);return new Promise(((n,i)=>{let o=a.createReadStream(e,{highWaterMark:1056784}),c=a.createWriteStream(t);const d=function(e,t,s){function r(e){return e}switch(e=e||/(\r?\n)/,t=t||r,s=s||{},arguments.length){case 1:"function"==typeof e?(t=e,e=/(\r?\n)/):"object"!=typeof e||e instanceof RegExp||(s=e,e=/(\r?\n)/);break;case 2:"function"==typeof e?(s=t,t=e,e=/(\r?\n)/):"object"==typeof t&&(s=t,t=r)}let n="";return(s=Object.assign({},s)).transform=function(s,r,i){var o;n+=s,o=n.split(e),n=o.pop();for(var a=0;a<o.length;a++)try{this.push(t(o[a]))}catch(e){return i(e)}i()},s.flush=function(e){if(n)try{this.push(t(n))}catch(t){return e(t)}e()},s.readableObjectMode=!0,new h(s)}((e=>s.reduce(((e,t)=>t(e)),e)));let f=new p(l.decodeStream(r),d,l.encodeStream(r));u(o,f,c,(e=>{e?i(e):n()}))}))},modifyByStreams:async function(e,t,s){const r=await j(e);if(!l.encodingExists(r))throw new Error("unsupport encoding "+r);return new Promise(((n,i)=>{let o=a.createReadStream(e,{highWaterMark:1056784}),c=a.createWriteStream(t),h=new p(l.decodeStream(r),...s,l.encodeStream(r));u(o,h,c,(e=>{e?i(e):n()}))}))}};class U{patchs=[];mergedInfos;infos=[];constructor(){}register(e){if(this.patchs||(this.patchs=[]),this.patchs){if(this.patchs.some((t=>t.name===e.name)))return}this.patchs.push(e)}registers(e){e.forEach((e=>{this.register(e)}))}detect(e){return this.patchs.filter((t=>t.detect(e)))}add(t,s,r=null){if(this.infos.some((e=>e.src.indexOf(s)>=0)))throw new Error("重复add，请检查");let n;if(r)n=new A(s,r,[]);else{let t=e.basename(s);if("~"===t.substr(0,1))throw new Error(`文件不能以~开头，请修改 ${s}`);{let r=e.join(s,"..","~"+t);n=new A(s,r,[]),n.isTempFileDest=!0}}return n.patchs=t,this.infos.push(n),n}detectAndAdd(e,t=null){let s=this.detect(e);return s&&s.length>0?this.add(s,e,t):null}async run(e){const t=e.patchs.map((t=>t.run(e)));return await _.modify(e.src,e.dest,t)}async runAll(){const e=this.infos.map((e=>this.run(e)));return Promise.resolve(e)}getPatch(e){return this.patchs.find((t=>t.name===e))}async clear(){const e=this.infos.map((async e=>e.isTempFileDest?await c.unlink(e.dest):Promise.resolve()));return Promise.all(e)}}class O{name;constructor(e){this.name=e}toString(){return this.name}}class A{src;dest;patchs;isTempFileDest=!1;constructor(e,t,s){this.src=e,this.dest=t,this.patchs=s}equal(e){return e.src==this.src&&e.dest==this.dest}merge(e){this.patchs=this.patchs.concat(e.patchs)}clone(){return new A(this.src,this.dest,this.patchs)}}const Q=/((src|href)\s*\=\s*['"])http(s)?\:/g,$=/(url\(\s*['"]?)http(s)?\:/g;class N extends O{warningWhenNotHttps=!1;constructor(){super("DeleteProtocolPatch")}setWaringWhenNotHttps(e){this.warningWhenNotHttps=e}async prepare(){return Promise.resolve()}detect(t){const s=e.extname(t);return[".html",".shtml",".htm",".inc",".css"].indexOf(s)>=0}run(t){const s=e.extname(t.src),r=[".css"].indexOf(s)>=0;return this._replace(r)}_replace(e){var t=this;return s=>{let r=s;return e?r=t.deleteProtocolInStyle(r):(r=t.deleteProtocolInStyle(r),r=t.deleteProtocolInHTMLTag(r)),r}}_stream(e){var t=this;return new h({transform:function(s,r,n){e?s=t.deleteProtocolInStyle(s):(s=t.deleteProtocolInStyle(s),s=t.deleteProtocolInHTMLTag(s)),this.push(s),n()}})}deleteProtocolInStyle(e){return this.warningWhenNotHttps?(this.warningWhenFindHttp(e),e):e=e.replace($,(e=>e?e.replace(/http(s)?\:/,""):e))}deleteProtocolInHTMLTag(e){return this.warningWhenNotHttps?(this.warningWhenFindHttp(e),e):e=e.replace(Q,(e=>e?e.replace(/http(s)?\:/,""):e))}warningWhenFindHttp(e){const t=e.match(Q),s=t?t[0]:"";if(s&&s.search("http:")>=0)throw new Error(`强制https时发现http，请检查 ${e} 后重新分离。`)}}const D=/<([^>]+)\s*(src|href|poster)(\s*=['"])(\.+\/)*(images|ossweb-img)(.*['"])[^>]*>/g,q=/([#\s\w]*)(url\(\s*['"]?)(\.+\/)*(images|ossweb-img)/g;class L extends O{fenliPath;constructor(){super("FenliPatch")}setFenliPath(e){this.fenliPath=e}async prepare(){return Promise.resolve()}detect(t){const s=e.extname(t);return[".html",".shtml",".htm",".inc",".css"].indexOf(s)>=0}run(t){if(!this.fenliPath)throw new Error("分离地址为空，请检查。");const s=e.extname(t.src),r=[".css"].indexOf(s)>=0;return this._replace(r)}_replace(e){var t=this;return s=>{let r=s;return e?r=t.replaceRelativeUrlsInStyle(r):(r=t.replaceRelativeUrlsInStyle(r),r=t.replaceRelativeUrlsInHTMLTag(r)),r}}_stream(e){var t=this;return new h({transform:function(s,r,n){console.log("chunk-----"),console.log(s.substr(0,100)),console.log(s.substr(s.length-100)),console.log("chunk+++++"),e?s=t.replaceRelativeUrlsInStyle(s):(s=t.replaceRelativeUrlsInStyle(s),s=t.replaceRelativeUrlsInHTMLTag(s)),this.push(s),n()}})}replaceRelativeUrlsInStyle(e){return e=e.replace(q,(e=>e?e.replace(/(\.+\/)*(images|ossweb-img)/g,this.fenliPath):e))}replaceRelativeUrlsInHTMLTag(e){return e=e.replace(D,((e,t,s,r,n,i)=>e?e.replace(/(\.+\/)*(images|ossweb-img)/g,this.fenliPath):e))}}const W=b("Fenli");class M extends v{sources;forceHttps;fenliPath;patchInstaller;constructor(e,t=!1){super(),this.sources=e,this.forceHttps=t}async run(e,t){try{await this.init(e,t),await this.start(),W(S("fenli success.","SUCCESS"))}catch(e){throw W(S("fenli fail.","ERROR")),W(S(e,"ERROR")),W(e.stack),e}}async init(e,t){const s=await this.getFenliPath(e,t);this.fenliPath=o.trim(s),this.forceHttps&&(this.fenliPath=this.fenliPath.replace(/http(s)?:/,""),this.fenliPath=`https:${this.fenliPath}`),this.patchInstaller=new U;const r=new L,n=new N;return this.patchInstaller.register(r),this.patchInstaller.register(n),this.forceHttps&&n.setWaringWhenNotHttps(!0),s}async start(){return this.sources.reduce((async(e,t)=>{try{await e,W(S(`start ${S(t,"PATH")}`,"STEP")),await this.startOne(t)}catch(e){return Promise.reject(e)}return W(S(`finish ${S(t,"PATH")}`,"STEP")),Promise.resolve()}),Promise.resolve())}startOne(t){"/"===t.substr(t.length-1)&&(t=t.substr(0,t.length-1));const s=t+"分离后",r=e.basename(t);return this.patchInstaller.getPatch("FenliPatch").setFenliPath(this.fenliPath+r),R(t,(({filePath:r,type:n})=>{let i=e.join(s,e.relative(t,r));if("file"===n){let s=this.patchInstaller.detectAndAdd(r,i);return s?(W(S(`replace ${S(e.relative(t,r),"PATH")} > ${S(e.relative(t,i),"PATH")}`)),this.patchInstaller.run(s)):(W(S(`cp ${S(e.relative(t,r),"PATH")} > ${S(e.relative(t,i),"PATH")}`)),C(r,i))}return W(S(`create dir ${S(e.relative(t,i),"PATH")}`)),C(r,i)}))}async getFenliPath(e,t){if(e){let t=(await this.loadFenliData()).find((t=>t.product.indexOf(e.toLowerCase())>=0));return t?Promise.resolve(t.url):Promise.reject(new Error("未找到别名("+e+")的分离地址"))}return t?Promise.resolve(t):Promise.reject(new Error("未指定分离地址"))}async loadFenliData(){W(S("load fenli data.","STEP"));try{const e=await i("https://api.egooidea.com/fenli/list");if(e.ok){const t=await e.json();if(t&&0==t.ret)return Promise.resolve(t.data);throw W(S("load fenli data error.","ERROR")),new Error("can't load fenli data.")}throw new Error("can't load fenli data.")}catch(e){throw e}}shutdownHandler(){W(S("shutdown"))}}const B="aes-256-cbc",G=16,J="utf8",V="hex";function K(e,t){try{const s=JSON.stringify(t),r=g.randomBytes(G),n=g.createCipheriv(B,e,r),i=n.update(s,J,V)+n.final(V),o={iv:r.toString(V),data:i};return JSON.stringify(o)}catch(e){throw e}}function z(e,{iv:t,data:s}){try{const r=Buffer.from(t,V),n=g.createDecipheriv(B,e,r),i=n.update(s,V,J)+n.final(J);return JSON.parse(i)}catch(e){throw e}}var X=e=>{const t=function(e){return g.createHash("sha256").update(e).digest()}(e);return{encrypt:K.bind(null,t),decrypt:z.bind(null,t)}};const Y=m(import.meta.url),Z=b("SSHClient");class ee{useCipher;configFilePath;client;serverCfg;constructor(e){this.useCipher=!0,e&&(this.useCipher=!1),this.configFilePath=e||x("server_config.json")}async loadServerConfig(){if(Z(S("load server config.","STEP")),t=this.configFilePath,/^(http(s)?:)?\/\//i.test(t))try{const e=await i(this.configFilePath,{});if(e.ok){const t=await e.json(),s=this.useCipher?await this.cipherDecrypt(t):t;return this.serverCfg=s,Promise.resolve(this.serverCfg)}throw new Error(e.statusText)}catch(e){throw e}else try{let t=e.resolve(this.configFilePath);return this.serverCfg=Y(t),Promise.resolve(this.serverCfg)}catch(e){throw e}var t}async cipherDecrypt(t){let s=e.join(w.homedir(),".egookey");try{const e=await c.readFile(s,"utf8"),r=X(e).decrypt(t);let n;return n="string"==typeof r?JSON.parse(r):r,Promise.resolve(n)}catch(e){throw e}}connect(){return Z(S("connecting...","STEP")),new Promise(((e,t)=>{let s=new f;s.on("ready",(()=>{this.client=s,Z(S("ssh connected.","STEP")),e()})).on("error",(e=>{t(e)})).connect({host:this.serverCfg.host,port:this.serverCfg.port,username:this.serverCfg.username,password:this.serverCfg.password,forceIPv4:!0})}))}openSFTP(){return new Promise(((e,t)=>{this.client.sftp(((s,r)=>{s?t(s):(Z(S("sftp opened.","STEP")),e(r))}))}))}execCmd(e){return new Promise(((t,s)=>{this.client.exec(e,(function(e,r){e&&s(e),r.on("end",(function(e,s){t()})).on("data",(function(e){console.log(e.toString())})).stderr.on("data",(function(e){console.log(e.toString())}))}))}))}close(){return new Promise(((e,t)=>{try{this.client.end(),Z(S("ssh closed.","STEP")),e()}catch(e){t(e)}}))}}const te=m(import.meta.url),se=b("VersionCtrl");class re{static FILENAME="config_versions.json";assets;included=!1;confPath="";constructor(){this.confPath=k(re.FILENAME)}init(){if(!this.included)try{this.assets=te(this.confPath)||{},this.included=!0}catch(e){this.assets={}}}checkUpdate(e){const t=o.get(this.assets,`${e}.ttl`),s=(new Date).getTime();return!t||s>t}save(e){const t=(new Date).getTime();return o.set(this.assets,`${e}.ttl`,t+1728e5),this.assets?(se(S("save conf.","STEP")),c.writeFile(this.confPath,JSON.stringify(this.assets))):Promise.resolve()}}const ne=m(import.meta.url),ie=b("UserConf");class oe{assets;included;confPath;constructor(){this.assets=null,this.included=!1,this.confPath=""}include(e=null){return this.confPath=k(e||"user_conf.json"),this.included?Promise.resolve():this.createDataDir().then((e=>{if(e){try{this.assets=ne(this.confPath)||{},ie(S("include user conf.","STEP"))}catch(e){}return Promise.resolve()}ie(S("找不到data文件夹","ERROR"))}))}async createDataDir(){let e=T("data");console.log(e);try{await c.lstat(e);return Promise.resolve(!0)}catch(t){console.log(t);try{return await c.mkdir(e),Promise.resolve(!0)}catch(e){return ie("create data directory"),Promise.reject(e)}}}add(e,t){this.assets||(this.assets={});let s=e.split(".");s.reduce(((e,r,n)=>n<s.length-1?(e[r]||(e[r]={}),e[r]):(e[r]=t,e)),this.assets)}get(e){return e.split(".").reduce(((e,t,s)=>e?e[t]:null),this.assets)}save(){return this.assets?(ie(S("save user conf.","STEP")),c.writeFile(this.confPath,JSON.stringify(this.assets))):Promise.resolve()}static __instance;static getInstance(){return oe.__instance||(oe.__instance=new oe),oe.__instance}}const ae=m(import.meta.url),ce=b("ConfCenter");class le{versionCtrl;assets={};included=!1;constructor(){this.versionCtrl=new re,this.assets={}}async include(e,t=!1){if(this.included)return Promise.resolve();{ce(S("include","STEP")),await oe.getInstance().createDataDir(),await this.versionCtrl.init();const s=k(`${e}.json`);(t||this.versionCtrl.checkUpdate(e))&&(await this.load(e,s),await this.versionCtrl.save(e));try{this.assets[e]=ae(s)||{},this.included=!0}catch(t){this.assets[e]={}}}}async load(e,t){return ce(S("load","STEP")),new Promise(((s,r)=>{i(x(`${e}.json`)).then((e=>{if(e.ok){var n=a.createWriteStream(t);e.body.pipe(n).on("finish",(()=>{s(!0)}))}else r(e.statusText)})).catch((e=>r(e)))}))}get(e,t){const s=this.assets[e];return s?o.get(s,t):null}static __instance;static getInstance(){return le.__instance||(le.__instance=new le),le.__instance}}const he=b("GitMode");class ue{constructor(e){e.hooks.complete.tapPromise("GitModePlugin",(()=>this.sync(e)))}async sync(e){const t=e.ssh;await this.execGitCmd(t,"status"),await this.execGitCmd(t,"add . --all"),await this.execGitCmd(t,'commit -m "update"'),await this.execGitCmd(t,"push origin master")}execGitCmd(e,t){const s=`git -C /media/gitee/pages ${t}`;return he(S(s,"STEP")),e.execCmd(s)}}const pe=m(import.meta.url),de=b("ServerHash"),fe="md5",me="",we=32,ge="filehash.json";class ye{fileInfos={};constructor(e){e.hooks.beforeQuery.tapPromise("ServerHashPlugin",(t=>this.beforeBuildQuery(e,t))),e.hooks.afterQuery.tapPromise("ServerHashPlugin",(t=>this.afterBuildQuery(e,t))),e.hooks.afterUpload.tapPromise("ServerHashPlugin",(()=>this.afterUploadQuery())),e.hooks.query.tapPromise("ServerHashPlugin",((e,t)=>this.onQueryFile(e,t))),e.hooks.dispose.tapPromise("ServerHashPlugin",(()=>this.clear()))}async beforeBuildQuery(e,t){await this.include(e.sftp,t.source,t.remote)}async afterBuildQuery(e,t){if(await this.save(t)){const s=this.fileInfos[t.source];e.pushQuery(s.filePath,s.serverPath,"file")}}async afterUploadQuery(){await this.clear()}async onQueryFile(e,t){const s=e.src;if(this.isNotHashFile(s)){if(!await this.compare(s,t))return e;de(S("skip: "+S(s,"PATH")))}}include(t,s,r){const n={filePath:e.join(s,ge),serverPath:I(r,ge),assets:null,saved:!1};return this.fileInfos[s]=n,H(t.fastGet,t,!0,n.serverPath,n.filePath).then((t=>{if(t){de(S("server hash file loaded.","STEP"));let t=e.resolve(n.filePath);try{n.assets=pe(t)||{},de(S("include hash file.","STEP"))}catch(e){Promise.reject(new Error("require hash file error."))}return Promise.resolve()}return de(S("server hash file isn't exists.","STEP")),Promise.resolve()}))}save(e){const t=this.fileInfos[e.source];return t&&t.assets?c.writeFile(t.filePath,JSON.stringify(t.assets)).then((()=>(t.saved=!0,de(S(`save hash file(${t.filePath}).`,"STEP")),Promise.resolve(!0)))):Promise.resolve(!1)}clear(){de(S("remove hash files.","STEP"));const e=Object.values(this.fileInfos).map((e=>e.saved&&e.filePath?c.unlink(e.filePath):Promise.resolve()));return Promise.all(e)}compare(t,s){const r=this.fileInfos[s.source];return c.readFile(t).then((s=>{let n="",i=e.resolve(t);r.assets&&r.assets[i]&&(n=r.assets[i]);let o=this.generateHash(s);return n!==o?(n=o,r.assets||(r.assets={}),r.assets[i]=n,Promise.resolve(!1)):Promise.resolve(!0)}))}generateHash(e){return e?me+g.createHash(fe).update(e).digest("hex").slice(0,we):""}isNotHashFile(t){return e.basename(t)!==ge}}const Pe=b("Replacer");class ve{patchInstaller;constructor(e,t){e.hooks.afterInit.tap("ReplacerPlugin",(()=>{this.patchInstaller=new U,this.patchInstaller.registers(t)})),e.hooks.query.tapPromise("ReplacerPlugin",((e,t)=>this.onQueryFile(e,t))),e.hooks.afterQuery.tapPromise("ReplacerPlugin",(()=>this.patchInstaller.runAll())),e.hooks.afterUpload.tapPromise("ReplacerPlugin",(()=>(Pe(S("clear","STEP")),this.patchInstaller.clear()))),e.hooks.dispose.tapPromise("ReplacerPlugin",(()=>(Pe(S("clear","STEP")),this.patchInstaller.clear())))}async onQueryFile(t,s){const r=t.src,n=this.patchInstaller.detectAndAdd(r);if(n){let i=e.basename(r),o=e.extname(i);"index"==e.basename(r,o)&&[".html",".shtml",".htm"].indexOf(o)>=0&&(s.visitor=i);let a=n.dest;return Pe(S(`modify ${a}`,"STEP")),new Te(a,t.dest,t.type)}}}class Se extends O{constructor(){super("InjectedFilePatch")}detect(t){const s=e.extname(t);return[".html",".shtml",".htm"].indexOf(s)>=0}async prepare(){return le.getInstance().include("upload_config")}run(e){return this._replace()}_replace(){return e=>{const t=le.getInstance().get("upload_config","injected.jspath"),s=le.getInstance().get("upload_config","injected.csp");let r,n=le.getInstance().get("upload_config","injected.blockScripts");return n=JSON.stringify(n),r=s?e.replace("<head>",`<head>\n<meta http-equiv="Content-Security-Policy" content="${s}">`):e,t&&(r=r.replace("</head>",`\x3c!-- 预览专用js --\x3e\n<script src="${t}"><\/script>\n<script>\nblockScripts(${n})<\/script>\n</head>`)),r}}}class be extends O{constructor(){super("ReplacementPatch")}detect(t){const s=e.extname(t);return[".html",".shtml",".htm",".css",".js"].indexOf(s)>=0}async prepare(){return le.getInstance().include("upload_config")}run(t){const s=le.getInstance().get("upload_config","replacements");if(s&&Array.isArray(s)){const r=e.extname(t.src);return this._replace(s,r)}throw new Error("请检查upload_config replacements配置，应该为数组")}_replace(e,t){return s=>e.reduce(((e,s)=>("html"===s.ext?[".shtml",".html","htm"]:[]).indexOf(t)>=0&&s.rules&&s.rules.length>0?s.rules.reduce(((e,t)=>{try{let s=t.pattern;if(s){let r=new RegExp(s,"g");e=e.replace(r,t.replace)}}catch(e){throw e}return e}),e):e),s)}}const Ee=b("Uploader");class Te{src;dest;type;constructor(e,t,s){this.src=e,this.dest=t,this.type=s}toString(){return this.src+" > "+this.dest}}class Ie{source;remote;type;visitor;constructor(e,t,s){this.source=e,this.remote=t,this.type=s}}class xe extends v{uploads;querys;sftp;ssh;remotePath;previewUrl;isFile;hooks={};constructor(){super(),this.hooks={beforeInit:new y,afterInit:new y,beforeQuery:new y(["uinfo"]),query:new P(["qinfo","info"]),afterQuery:new y(["uinfo"]),beforeUpload:new y,afterUpload:new y,complete:new y,dispose:new y},this.uploads=[],this.querys=[]}async run(e,t,s,r){try{await this.init(e,t,s,r),await this.connect(),await this.start(),await this.close(),Ee(S("publish success.","SUCCESS")),Ee(S("preview url: "+this.getPreviewURLs().map((e=>S(e,"UNDERLINE"))).join(" , ")))}catch(e){throw Ee(S("publish fail.","ERROR")),Ee(S(e,"ERROR")),Ee(e.stack),e}}async init(e,t,s,r=!1){await le.getInstance().include("upload_config",r);const n=le.getInstance().get("upload_config",`mode.${t}`);try{this.remotePath=n.remoteRootPath,this.previewUrl=n.previewBaseUrl}catch(e){throw new Error("配置文件mode中找不到remoteRootPath和previewBaseUrl，请检查")}let i=[];n.replaced&&!s.replaced&&i.push(new be),n.injected&&!s.injected&&i.push(new Se),new ve(this,i),s.cache||new ye(this),"git"==t.toLowerCase()&&new ue(this),await this.hooks.beforeInit.promise(),this.uploads=await this.isSourcesValid(e,this.remotePath),await this.hooks.afterInit.promise()}async connect(e=null){return this.ssh=new ee(e),await this.ssh.loadServerConfig(),await this.ssh.connect(),this.sftp=await this.ssh.openSFTP(),this.ssh}async close(){return await this.ssh.close()}getPreviewURLs(){return this.uploads.map((t=>this.previewUrl+e.basename(t.source)+"/"+(t.visitor||"")))}async start(){return this.uploads.reduce((async(e,t)=>{try{return await e,Ee(S(`start query ${S(t.source,"PATH")}`,"STEP")),await this.hooks.beforeQuery.promise(t),await this.buildQuery(t),await this.hooks.afterQuery.promise(t),Ee(S(`finish query ${S(t.source,"PATH")}`,"STEP")),Promise.resolve()}catch(e){return Promise.reject(e)}}),Promise.resolve()).then((async()=>{await this.hooks.beforeUpload.promise(),await this.uploadQuerys(this.sftp,this.querys),await this.hooks.afterUpload.promise()})).then((()=>this.hooks.complete.promise()))}async isSourcesValid(t,s){return t.reduce((async(t,r)=>{const n=await t;let i,o;try{i=await c.lstat(r)}catch(e){throw Ee(S(`上传路径:${r} 不正确`,"ERROR")),e}return o=i.isDirectory()?new Ie(r,I(s,e.basename(r)),"dir"):new Ie(r,s,"file"),n.push(o),n}),Promise.resolve([]))}pushQuery(e,t,s){this.querys.push(new Te(e,t,s))}buildQuery(t){return R(t.source,(async({filePath:s,type:r})=>{let n=e.basename(t.source),i=e.relative(t.source,s).split(e.sep);const o=I(this.remotePath,n,i);let a=new Te(s,o,r);if("dir"==r)this.querys.push(a);else{const e=await this.hooks.query.promise(a,t);e&&(a=e,this.querys.push(a))}}))}uploadQuerys(e,t){return Ee(S("start upload query.","STEP")),new Promise(((s,r)=>{this.uploadQuery(e,t,0).then((e=>{e?(Ee(S("finish upload query.","STEP")),s()):r("query upload errors somewhere.")})).catch((e=>{r(e)}))}))}uploadQuery(e,t,s){if(s===t.length)return t=null,!0;let r,{src:n,dest:i,type:o}=t[s];return"dir"===o?r=H(e.opendir,e,!0,i).then((t=>t||(Ee(S("mkdir: "+S(i,"PATH"))),H(e.mkdir,e,!1,i)))).then((t=>{if(!t)return Ee(S("chmod directory: "+S(i,"PATH"))),H(e.chmod,e,!1,i,"0777")})).then((()=>(s++,this.uploadQuery(e,t,s)))):"file"===o&&(r=H(e.open,e,!0,i,"r").then((t=>{if(t)return Ee(S("rm: "+S(i,"PATH"))),H(e.unlink,e,!1,i)})).then((()=>(Ee(S("cp: "+S(n,"PATH")+" > "+S(i,"PATH"))),H(e.fastPut,e,!1,n,i)))).then((()=>(s++,this.uploadQuery(e,t,s))))),r}shutdownHandler(){this.hooks.dispose.promise()}}const ke=e.dirname(new URL(import.meta.url).pathname);var Re;let He;Re=e.join(ke,".."),E=Re,t.scriptName("egoo").version().alias("version","v").command({command:"publish <source> [others...]",aliases:["pub"],describe:"上传文件到服务器",builder:{top:{describe:"等同于--mode egoo",type:"boolean",default:!1},egoo:{alias:"e",describe:"上传到egoodev.top。等同于--mode egoo",type:"boolean",default:!1},pinna:{alias:"p",describe:"上传到pinnadev.top。等同于--mode pinna --ignore-injected --ignore-replaced",type:"boolean",default:!1},mode:{describe:"上传的模式，可以是top/pinna，默认为top，上传到egoodev.top",type:"string",default:"egoo"},"ignore-cache":{describe:"忽略缓存，全量上传",type:"boolean",default:!1},"ignore-injected":{describe:"忽略文件注入",type:"boolean",default:!1},"ignore-replaced":{describe:"忽略文本替换",type:"boolean",default:!1},"config-forcereload":{describe:"重新加载配置文件",type:"boolean",default:!1}},handler:async e=>{let{source:t,others:s,top:r,egoo:n,pinna:i,mode:o}=e;o=o.toLowerCase(),r||n?o="egoo":i&&(o="pinna");let a={};for(const t in e)t.indexOf("ignore-")>=0&&(a[t.replace("ignore-","")]=e[t]);const c=[t].concat(s),l=e["config-forcereload"],h=new xe;He=h,await h.run(c,o,a,l)}}).command({command:"fenli <source> [others...]",describe:"分离",builder:{url:{alias:"u",describe:"指定分离路径。如（//game.gtimg.cn/images/dnf/cp/）",type:"string"},aliases:{alias:"a",describe:"项目所属游戏的别名，根据游戏找到对应分离路径。如地下城与勇士为dnf，QQ飞车为speed，王者荣耀为pvp。\b更多信息请查看https://fenli.egooidea.com",type:"string"},forcehttps:{describe:"强制https，会在分离地址前加上https:，同时，http: 地址会发出错误提示",type:"boolean"}},handler:async e=>{const{source:t,others:s,url:r,aliases:n,forcehttps:i}=e,o=[t].concat(s);let a=i;n&&"dnf"==n.toLowerCase()&&(a=!0);const c=new M(o,a);He=c,await c.run(n,r)}}).demandCommand(1,"请指定命令").onFinishCommand((e=>{process.exit()})).fail(((e,t)=>{console.error(t),He&&(console.log("shutdown"),He.emit("shutdown")),process.exit(1)})).help().argv,process.on("uncaughtException",(function(e){console.error(e),console.log(s.red(e.toString())),He&&(console.log("shutdown"),He.emit("shutdown"))})),process.on("SIGINT",(function(){He&&(console.log("shutdown"),He.emit("shutdown")),process.exit()}));
