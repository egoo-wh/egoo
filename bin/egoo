#!/usr/bin/env node

'use strict';

let commander = require('commander');
let pkg       = require('../package.json');
let CLI       = require('../lib/CLI');
const path = require('path');

global.rootPath = path.join(__dirname, '..');

let handler = null;

commander.version(pkg.version)
	.option('-v --version', 'output the version number');

/*
publish
 */
commander.command('publish <source>')
	.alias('pub')
	.description('上传内容至服务器')
	.option('-d --dist', '上传到外网')
	.option('-r --remotepath [value]', '服务器目标目录，默认为/mnt/preview/')
	.option('--nocache', '无需文件缓存，即没有hash缓存文件(filehash.json)')
	.option('-c --configpath [value]', '服务器配置文件地址，默认为http://192.168.1.11/static/server_config.json')
	.action(function(source, options){
		let dist = options.dist || false;
		let remotepath = options.remotepath || null;
		handler = CLI.publish(source, remotepath, options.nocache, options.configpath);
	});


/*
imgeven
 */
commander.command('imgeven <source>')
	.alias('ie')
	.description('图片尺寸偶数化')
	.action(function(source){
		handler = CLI.imgEven(source);
	});


/*
tinypng
 */
commander.command('tinypng <source>')
	.alias('tiny')
	.description('TinyPNG图片压缩')
	.action(function(source){
		handler = CLI.tinypng(source);
	});


/*
fenli
 */
commander.command('fenli <source>')
	.description('分离')
	.option('-u --url [value]', '指定分离路径。如（//game.gtimg.cn/images/dnf/cp/）')
	.option('-a --aliases [value]', '项目所属游戏的别名，根据游戏找到对应分离路径。如地下城与勇士为dnf，QQ飞车为speed，王者荣耀为pvp，一般为游戏的官网缩写。')
	.action(function(source, options){
		let aliases = options.aliases || null;
		let url = options.url || null;
		handler = CLI.fenli(source, aliases, url);
	});

/*
git publish
 */
commander.command('gitpub <source>')
	.description('上传内容至gitee.com pages服务')
	.action(function(source, options){
		handler = CLI.gitPub(source);
	});

commander.parse(process.argv);


// shutdown.  ctrl-c强制退出
process.on("SIGINT", function () {
  //graceful shutdown
  if (handler) {
  	console.log('shutdown');
  	handler.emit('shutdown');
  };

  process.exit();
});
